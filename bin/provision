#!/bin/bash

DOCKER_INSTALLER_URL="https://get.docker.com/"
DOCKER_COMPOSE_VERSION=$(git ls-remote "https://github.com/docker/compose" | grep refs/tags | grep -oP "[0-9]+\.[0-9][0-9]+\.[0-9]+$" | tail -n 1)
# RVM_INSTALLER_URL="https://get.rvm.io"
RVM_INSTALLER_URL="https://raw.githubusercontent.com/wayneeseguin/rvm/stable/binscripts/rvm-installer"
CODEDEPLOY_INSTALLER_URL="https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install"
MONITORING_INSTALLER_URL="https://aws-cloudwatch.s3.amazonaws.com/downloads/CloudWatchMonitoringScripts-1.2.2.zip"

# hostname config (for sudo to work properly)
echo "$(curl -s http://169.254.169.254/latest/meta-data/local-ipv4)" "$(hostname)" | sudo tee -a /etc/hosts

# packages
apt-get update
DEBIAN_FRONTEND=noninteractive apt-get upgrade -y \
               -o Dpkg::Options::="--force-confdef" \
               -o Dpkg::Options::="--force-confold"
apt-get install -y \
        jq \
        rpm \
        htop \
        libaio1 \
        libpq-dev \
        libmysqlclient-dev \
        mysql-client \
        libgmp3-dev \
        libmysql-java \
        openjdk-8-jre \
        wget \
        python-pip \
        unzip \
        libwww-perl \
        libdatetime-perl

# docker
wget -qO- "$DOCKER_INSTALLER_URL" | sh
usermod -aG docker ubuntu
service docker start

# docker-compose
curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o "/usr/local/bin/docker-compose"
sudo chmod +x /usr/local/bin/docker-compose
curl -L "https://raw.githubusercontent.com/docker/compose/$(docker-compose version --short)/contrib/completion/bash/docker-compose" -o "/etc/bash_completion.d/docker-compose"

# ruby
curl -sSL https://rvm.io/mpapis.asc | gpg --import -
curl -sSL "$RVM_INSTALLER_URL" | bash -s stable --ruby={2.3.0,2.4.1,2.4.2,2.4.3} --gems=bundler,dotenv,pry
usermod -aG rvm root
usermod -aG rvm ubuntu

# CloudWatch Monitoring
command="/root/aws-scripts-mon/mon-put-instance-data.pl --mem-util --mem-used --mem-avail --disk-path=/ --disk-space-util --disk-space-used --disk-space-avail --verbose --from-cron"
job="*/5 * * * * $command"
curl -sSL "$MONITORING_INSTALLER_URL" -o "/root/aws-scripts-mon.zip"
unzip /root/aws-scripts-mon.zip -d /root && rm /root/aws-scripts-mon.zip
cat <(grep -F -i -v "$command" <(crontab -l)) <(echo "$job") | crontab -

# codedeploy
cd /home/ubuntu || true
wget "$CODEDEPLOY_INSTALLER_URL"
chmod +x ./install
bash -l -c "ruby ./install auto"
service codedeploy-agent start

# csysdig: container htop
curl -s https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public | apt-key add -
curl -s -o /etc/apt/sources.list.d/draios.list http://download.draios.com/stable/deb/draios.list
apt-get update
apt-get -y install "linux-headers-$(uname -r)"
apt-get -y install sysdig
