#!/usr/bin/env bash
set -euo pipefail

# Pull params you don't have, but keep ones that aren't in parameter store

app_name="$1"
app_env="$2"
in_env_file="${3:-.env.$app_env}"
out_env_file="${4:-$in_env_file}"
prefix="/$app_env/$app_name/"

if [[ ! -f "$in_env_file" ]]
then
    touch "$in_env_file"
fi

# shellcheck disable=SC2016
remote_list=$(aws --region us-east-1 ssm get-parameters-by-path \
                  --with-decryption \
                  --path "$prefix" \
                  --output text \
                  --query 'Parameters[*].[join(`=`, [Name, Value])][] | join(`"\n"`, @)' | sort)

local_list=''
while IFS=$' \t\n\r' read -r line
do
    var_name=''
    var=''
    first="${line:0:1}"
    if [ "$first" != "#" ] && [ "x$line" != x ]
    then
        var_name=${line%%"="*}
        var=${line#*"="}
        if [[ ( "${var:0:1}" == '"' && "${var: -1:1}" == '"' ) || ( "${var:0:1}" == "'" && "${var: -1:1}" == "'" ) ]]
        then
            var=$(eval echo "$var")
        fi
        local_list="$local_list$prefix$var_name=$var\n"
    fi
done < "$in_env_file"

local_list=$(echo -e "${local_list%??}" | sort)

# shows what exists in AWS and not local
new_vars=$(diff -B \
                --unchanged-line-format= \
                --old-line-format= \
                --new-line-format='%L' \
                <(echo "$local_list") <(echo "$remote_list") || true)

new_vars=$(echo -n "$new_vars" | sed -Ee 's;^[a-z0-9_/]+;;')

relative_local_list=$(cat "$in_env_file")

while IFS=$' \t\n\r' read -r line
do
    if [ "x$line" != x ]
    then
        var_name=''
        var=''
        var_name=${line%%"="*}
        var=${line#*"="}
        quoted_var="$var_name=\"$var\""

        exists_locally=$(echo "$relative_local_list" | grep "$var_name" || :)
        if [ -n "$exists_locally" ] # substitute local value with remote
        then
            # shellcheck disable=SC2001
            relative_local_list=$(echo "$relative_local_list" | sed "s/$var_name=.*/${line//\//\\/}/")
        else # add the remote value to the list
            if [ -z "$relative_local_list" ] # list is empty, don't start with newline
            then
                relative_local_list="$quoted_var"
            else
                relative_local_list="$relative_local_list\n$quoted_var"
            fi
        fi
    fi
done <<< "$new_vars"
echo -e "$relative_local_list" > "$out_env_file"
